# Инструкция по сборке через Docker

## Быстрый старт

На macOS выполните:

```bash
./build-windows.sh Release
```

Готовые файлы будут в `build-windows/deploy/`.

## Подробное описание процесса

### Шаг 1: Установка Docker Desktop

Убедитесь, что у вас установлен Docker Desktop для macOS:

- Скачайте с [docker.com](https://www.docker.com/products/docker-desktop)
- Установите и запустите Docker Desktop

### Шаг 2: Первая сборка

При первой сборке Docker образ будет собираться долго (1-2 часа), так как MXE компилирует кросс-компилятор и Qt6 из исходников. Это происходит только один раз.

**Важно:** Сборка MXE разбита на отдельные шаги в Dockerfile:
1. Клонирование MXE (быстро)
2. Настройка конфигурации (быстро)
3. Сборка базового toolchain (gcc, binutils) - 30-60 минут
4. Сборка Qt6 base - 30-60 минут
5. Сборка Qt6 tools - 10-30 минут

Каждый шаг кэшируется в отдельном слое Docker образа. Если сборка прервется на каком-то шаге, при следующей попытке Docker использует кэшированные слои до места ошибки, и пересоберет только то, что нужно.

```bash
./build-windows.sh Release
```

### Шаг 3: Последующие сборки

После первой успешной сборки все слои образа будут закэшированы. При пересборке образа (например, после изменения Dockerfile) Docker будет использовать кэшированные слои до измененного места, что значительно ускоряет процесс.

Если сборка вашего приложения завершится с ошибкой, образ останется неизменным, и при следующем запуске не потребуется пересборка MXE.

## Структура файлов

- `Dockerfile` - определение Docker образа с MXE и Qt6
- `docker-compose.yml` - конфигурация для удобной сборки
- `build-windows.sh` - скрипт автоматизации сборки
- `.dockerignore` - файлы, исключаемые из Docker контекста

## Ручная сборка (без скрипта)

Если хотите выполнить сборку вручную:

```bash
# Сборка образа
docker compose build

# Запуск интерактивной сессии
docker compose run --rm builder

# Внутри контейнера:
cmake -B build-windows \
    -G 'Unix Makefiles' \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_TOOLCHAIN_FILE=/opt/mxe/usr/x86_64-w64-mingw32.static/share/cmake/mxe-conf.cmake \
    -DCMAKE_PREFIX_PATH=/opt/mxe/usr/x86_64-w64-mingw32.static/qt6

cmake --build build-windows

# Развертывание DLL
/opt/mxe/usr/x86_64-w64-mingw32.static/qt6/bin/windeployqt.exe \
    --compiler-runtime \
    --release \
    --dir build-windows/deploy \
    build-windows/qt-test-app.exe
```

## Устранение неполадок

### Проблема: Docker образ не собирается

**Решение:** Убедитесь, что Docker Desktop запущен и имеет достаточно ресурсов (рекомендуется минимум 4GB RAM).

### Проблема: Ошибка при компиляции Qt6 в MXE

**Решение:** 
- Убедитесь, что у вас достаточно места на диске (минимум 15GB свободного места для сборки MXE)
- Если сборка прервалась на этапе сборки MXE, при следующей попытке Docker автоматически использует кэшированные слои до места ошибки
- Каждый шаг сборки MXE (gcc/binutils, qt6-qtbase, qt6-qttools) кэшируется отдельно, поэтому пересборка будет быстрее

### Проблема: windeployqt не найден

**Решение:** Проверьте, что Qt6 установлен в MXE:

```bash
docker compose run --rm builder ls -la /opt/mxe/usr/x86_64-w64-mingw32.static/qt6/bin/
```

### Проблема: Исполняемый файл не запускается на Windows

**Решение:** Убедитесь, что все необходимые DLL скопированы. Проверьте папку `build-windows/deploy/` и убедитесь, что там есть все необходимые файлы.

## Альтернативные подходы

Если MXE не работает или сборка занимает слишком много времени, рассмотрите альтернативы:

1. **GitHub Actions** - настройте CI/CD для автоматической сборки на Windows
2. **Windows VM** - используйте виртуальную машину Windows на macOS
3. **Облачная сборка** - используйте сервисы вроде AppVeyor или Azure DevOps

## Дополнительная информация

- [MXE документация](https://mxe.cc/)
- [Qt кросс-компиляция](https://doc.qt.io/qt-6/linux-building.html)
- [Docker документация](https://docs.docker.com/)
